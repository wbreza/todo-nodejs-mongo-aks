# yaml-language-server: $schema=azure.yaml.json

name: todo-nodejs-mongo-aks
metadata:
  template: todo-nodejs-mongo-aks@0.0.1-beta
services:
  todo:
    host: aks
    containers:
      web:
        project: ./src/web
        dist: build
        language: js
      api:
        project: ./src/api
        language: js
    k8s:
      helm:
        releases:
          - name: todo
            chart: ./charts/todo
            values: ./charts/todo/values.yaml
            namespace: todo-helm
            overrides:
              cluster.clientId: ${AZURE_AKS_IDENTITY_CLIENT_ID}
              keyvault.endpoint: ${AZURE_KEY_VAULT_ENDPOINT}
              appInsights.connectionString: ${APPLICATIONINSIGHTS_CONNECTION_STRING}
              api.image: ${SERVICE_API_IMAGE_NAME}
              web.image: ${SERVICE_WEB_IMAGE_NAME}
    hooks:
      postdeploy:
        shell: sh
        run: |
          azd env set REACT_APP_WEB_BASE_URL ${SERVICE_WEB_ENDPOINT_URL}
          azd env set REACT_APP_API_BASE_URL ${SERVICE_API_ENDPOINT_URL}
